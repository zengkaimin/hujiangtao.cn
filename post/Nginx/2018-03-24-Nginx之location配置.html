<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx之location配置 | 木先生</title>
    <meta name="description" content="Nginx之location配置">
    <link rel="icon" href="/favicon.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/favicon.png">
  <meta name="msapplication-TileImage" content="/favicon.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.593102d0.css" as="style"><link rel="preload" href="/assets/js/app.9c3b2f40.js" as="script"><link rel="preload" href="/assets/js/35.c94db349.js" as="script"><link rel="prefetch" href="/assets/js/10.db6d2b23.js"><link rel="prefetch" href="/assets/js/11.5eec0cf0.js"><link rel="prefetch" href="/assets/js/12.48cc16ff.js"><link rel="prefetch" href="/assets/js/13.227a98da.js"><link rel="prefetch" href="/assets/js/14.dd432dff.js"><link rel="prefetch" href="/assets/js/15.1937fbfb.js"><link rel="prefetch" href="/assets/js/16.249d8c5c.js"><link rel="prefetch" href="/assets/js/17.f336ed5e.js"><link rel="prefetch" href="/assets/js/18.4a0023fb.js"><link rel="prefetch" href="/assets/js/19.47d9327c.js"><link rel="prefetch" href="/assets/js/2.1faa0878.js"><link rel="prefetch" href="/assets/js/20.c4cd5dc9.js"><link rel="prefetch" href="/assets/js/21.2faac9e3.js"><link rel="prefetch" href="/assets/js/22.6159852d.js"><link rel="prefetch" href="/assets/js/23.4d8c66d7.js"><link rel="prefetch" href="/assets/js/24.ef8ce863.js"><link rel="prefetch" href="/assets/js/25.3cf50925.js"><link rel="prefetch" href="/assets/js/26.67d3b388.js"><link rel="prefetch" href="/assets/js/27.bf825405.js"><link rel="prefetch" href="/assets/js/28.0cb8a491.js"><link rel="prefetch" href="/assets/js/29.99578b0c.js"><link rel="prefetch" href="/assets/js/3.386eea71.js"><link rel="prefetch" href="/assets/js/30.252f5b97.js"><link rel="prefetch" href="/assets/js/31.028178c1.js"><link rel="prefetch" href="/assets/js/32.340c7f35.js"><link rel="prefetch" href="/assets/js/33.1e9d0600.js"><link rel="prefetch" href="/assets/js/34.8a8cce8c.js"><link rel="prefetch" href="/assets/js/36.0b7766b9.js"><link rel="prefetch" href="/assets/js/37.2ff91466.js"><link rel="prefetch" href="/assets/js/38.d9462a48.js"><link rel="prefetch" href="/assets/js/39.52a2f1e0.js"><link rel="prefetch" href="/assets/js/4.77a79f01.js"><link rel="prefetch" href="/assets/js/40.8f3c38e6.js"><link rel="prefetch" href="/assets/js/41.4006441f.js"><link rel="prefetch" href="/assets/js/42.c98081d3.js"><link rel="prefetch" href="/assets/js/43.2fc9c209.js"><link rel="prefetch" href="/assets/js/44.366bd44e.js"><link rel="prefetch" href="/assets/js/45.9baec45e.js"><link rel="prefetch" href="/assets/js/46.5d5e5cb3.js"><link rel="prefetch" href="/assets/js/47.474d0da3.js"><link rel="prefetch" href="/assets/js/48.34232f7f.js"><link rel="prefetch" href="/assets/js/49.269eae44.js"><link rel="prefetch" href="/assets/js/5.b97c8e99.js"><link rel="prefetch" href="/assets/js/50.ddc90ea9.js"><link rel="prefetch" href="/assets/js/51.0d496ebd.js"><link rel="prefetch" href="/assets/js/52.5de4cba2.js"><link rel="prefetch" href="/assets/js/53.291d0b51.js"><link rel="prefetch" href="/assets/js/54.12c976d1.js"><link rel="prefetch" href="/assets/js/55.fcf3c75d.js"><link rel="prefetch" href="/assets/js/6.5fe59aa3.js"><link rel="prefetch" href="/assets/js/7.e4119528.js"><link rel="prefetch" href="/assets/js/8.b36d15bf.js"><link rel="prefetch" href="/assets/js/9.d504111d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.593102d0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">木先生</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="/contact.html" class="nav-link">Contact</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="/contact.html" class="nav-link">Contact</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Windows</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>TensorFlow</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Nginx</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/post/Nginx/2018-07-09-Nginx反向代理supervisor日志.html" class="sidebar-link">Nginx反向代理supervisor日志</a></li><li><a href="/post/Nginx/2018-03-24-Nginx之location配置.html" class="active sidebar-link">Nginx之location配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/post/Nginx/2018-03-24-Nginx之location配置.html#目录" class="sidebar-link">目录</a></li><li class="sidebar-sub-header"><a href="/post/Nginx/2018-03-24-Nginx之location配置.html#语法规则：" class="sidebar-link">语法规则：</a></li><li class="sidebar-sub-header"><a href="/post/Nginx/2018-03-24-Nginx之location配置.html#未试验过的其他信息：" class="sidebar-link">未试验过的其他信息：</a></li><li class="sidebar-sub-header"><a href="/post/Nginx/2018-03-24-Nginx之location配置.html#rewrite语法" class="sidebar-link">ReWrite语法</a></li><li class="sidebar-sub-header"><a href="/post/Nginx/2018-03-24-Nginx之location配置.html#redirect语法" class="sidebar-link">Redirect语法</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>MySQL</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Mac</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Frontend</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>API</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="nginx之location配置"><a href="#nginx之location配置" aria-hidden="true" class="header-anchor">#</a> Nginx之location配置</h1> <h2 id="目录"><a href="#目录" aria-hidden="true" class="header-anchor">#</a> 目录</h2> <p></p><div class="table-of-contents"><ul><li><a href="#目录">目录</a></li><li><a href="#语法规则：">语法规则：</a></li><li><a href="#未试验过的其他信息：">未试验过的其他信息：</a></li><li><a href="#rewrite语法">ReWrite语法</a></li><li><a href="#redirect语法">Redirect语法</a></li></ul></div><p></p> <h2 id="语法规则："><a href="#语法规则：" aria-hidden="true" class="header-anchor">#</a> 语法规则：</h2> <ul><li>语法规则</li></ul> <div class="language- extra-class"><pre class="language-text"><code>location [=|~|~*|^~] /uri/ { … }
= 开头表示精确匹配
^~ 开头表示uri以某个常规字符串开头，理解为匹配 url路径即可。nginx不对url做编码，因此请求为/static/20%/aa，可以被规则^~ /static/ /aa匹配到（注意是空格）。
~ 开头表示区分大小写的正则匹配
~* 开头表示不区分大小写的正则匹配
!~和!~*分别为区分大小写不匹配及不区分大小写不匹配 的正则
/ 通用匹配，任何请求都会匹配到。
</code></pre></div><ul><li>多个location配置的情况下匹配顺序为（参考资料而来，还未实际验证，试试就知道了，不必拘泥，仅供参考）：</li></ul> <div class="language- extra-class"><pre class="language-text"><code>首先匹配 =，
其次匹配^~,
其次是按文件中顺序的正则匹配，
最后是交给 / 通用匹配。
当有匹配成功时候，停止匹配，按当前匹配规则处理请求。
</code></pre></div><ul><li>例子，有如下匹配规则：</li></ul> <div class="language- extra-class"><pre class="language-text"><code>location = / {
    #规则A
}
location = /login {
    #规则B
}
location ^~ /static/ {
    #规则C
}
location ~ \.(gif|jpg|png|js|css)$ {
    #规则D
}
location ~* \.png$ {
    #规则E
}
location !~ \.xhtml$ {
    #规则F
}
location !~* \.xhtml$ {
    #规则G
}
location / {
    #规则H
}
</code></pre></div><p>那么产生的效果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>访问根目录/， 比如http://localhost/ 将匹配规则A
访问 http://localhost/login 将匹配规则B，http://localhost/register 则匹配规则H
访问 http://localhost/static/a.html 将匹配规则C
访问 http://localhost/a.gif, http://localhost/b.jpg 将匹配规则D和规则E，但是规则D顺序优先，规则E不起作用，而 http://localhost/static/c.png 则优先匹配到 规则C
访问 http://localhost/a.PNG 则匹配规则E， 而不会匹配规则D，因为规则E不区分大小写。
访问 http://localhost/a.xhtml 不会匹配规则F和规则G，http://localhost/a.XHTML不会匹配规则G，因为不区分大小写。规则F，规则G属于排除法，符合匹配规则但是不会匹配到，所以想想看实际应用中哪里会用到。
访问 http://localhost/category/id/1111 则最终匹配到规则H，因为以上规则都不匹配，这个时候应该是nginx转发请求给后端应用服务器，比如FastCGI（php），tomcat（jsp），nginx作为方向代理服务器存在。
</code></pre></div><p>所以实际使用中，个人觉得至少有三个匹配规则定义，如下：</p> <div class="language- extra-class"><pre class="language-text"><code>#直接匹配网站根，通过域名访问网站首页比较频繁，使用这个会加速处理，官网如是说。
#这里是直接转发给后端应用服务器了，也可以是一个静态首页
# 第一个必选规则
location = / {
    proxy_pass http://tomcat:8080/index
}

# 第二个必选规则是处理静态文件请求，这是nginx作为http服务器的强项
# 有两种配置模式，目录匹配或后缀匹配,任选其一或搭配使用
location ^~ /static/ {
    root /webroot/static/;
}
location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ {
    root /webroot/res/;
}
 
#第三个规则就是通用规则，用来转发动态请求到后端应用服务器
#非静态文件请求就默认是动态请求，自己根据实际把握
#毕竟目前的一些框架的流行，带.php,.jsp后缀的情况很少了
location / {
    proxy_pass http://tomcat:8080/
}
</code></pre></div><h2 id="未试验过的其他信息："><a href="#未试验过的其他信息：" aria-hidden="true" class="header-anchor">#</a> 未试验过的其他信息：</h2> <h2 id="rewrite语法"><a href="#rewrite语法" aria-hidden="true" class="header-anchor">#</a> ReWrite语法</h2> <ul><li>基本语法</li></ul> <div class="language- extra-class"><pre class="language-text"><code>last – 基本上都用这个Flag。
break – 中止Rewirte，不在继续匹配
redirect – 返回临时重定向的HTTP状态302
permanent – 返回永久重定向的HTTP状态301
注：last和break最大的不同在于
- break是终止当前location的rewrite检测,而且不再进行location匹配 - last是终止当前location的rewrite检测,但会继续重试
</code></pre></div><ul><li>location匹配并处理区块中的rewrite规则</li></ul> <p>1、下面是可以用来判断的表达式：</p> <div class="language- extra-class"><pre class="language-text"><code>-f和!-f用来判断是否存在文件
-d和!-d用来判断是否存在目录
-e和!-e用来判断是否存在文件或目录
-x和!-x用来判断文件是否可执行
</code></pre></div><p>2、下面是可以用作判断的全局变量</p> <div class="language- extra-class"><pre class="language-text"><code>$args #这个变量等于请求行中的参数。
$content_length #请求头中的Content-length字段。
$content_type #请求头中的Content-Type字段。
$document_root #当前请求在root指令中指定的值。
$host #请求主机头字段，否则为服务器名称。
$http_user_agent #客户端agent信息
$http_cookie #客户端cookie信息
$limit_rate #这个变量可以限制连接速率。
$request_body_file #客户端请求主体信息的临时文件名。
$request_method #客户端请求的动作，通常为GET或POST。
$remote_addr #客户端的IP地址。
$remote_port #客户端的端口。
$remote_user #已经经过Auth Basic Module验证的用户名。
$request_filename #当前请求的文件路径，由root或alias指令与URI请求生成。
$query_string #与$args相同。
$scheme #HTTP方法（如http，https）。
$server_protocol #请求使用的协议，通常是HTTP/1.0或HTTP/1.1。
$server_addr #服务器地址，在完成一次系统调用后可以确定这个值。
$server_name #服务器名称。
$server_port #请求到达服务器的端口号。
$request_uri #包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”。
$uri #不带请求参数的当前URI，$uri不包含主机名，如”/foo/bar.html”。
$document_uri #与$uri相同。
例：http://localhost:88/test1/test2/test.php
$host：localhost
$server_port：88
$request_uri：http://localhost:88/test1/test2/test.php
$document_uri：/test1/test2/test.php
$document_root：D:\nginx/html
$request_filename：D:\nginx/html/test1/test2/test.php
</code></pre></div><h2 id="redirect语法"><a href="#redirect语法" aria-hidden="true" class="header-anchor">#</a> Redirect语法</h2> <ul><li>多目录转成参数</li></ul> <div class="language- extra-class"><pre class="language-text"><code>abc.domian.com/sort/2 =&gt; abc.domian.com/index.php?act=sort&amp;name=abc&amp;id=2

if ($host ~* (.*)\.domain\.com) {
    set $sub_name $1; 
    rewrite ^/sort\/(\d+)\/?$ /index.php?act=sort&amp;cid=$sub_name&amp;id=$1 last;
}
</code></pre></div><ul><li>目录对换</li></ul> <p>/123456/xxxx -&gt; /xxxx?id=123456</p> <div class="language- extra-class"><pre class="language-text"><code>rewrite ^/(\d+)/(.+)/ /$2?id=$1 last;
</code></pre></div><ul><li>例如下面设定nginx在用户使用ie的使用重定向到/nginx-ie目录下：</li></ul> <div class="language- extra-class"><pre class="language-text"><code>if ($http_user_agent ~ MSIE) {
    rewrite ^(.*)$ /nginx-ie/$1 break;
}
</code></pre></div><ul><li>目录自动加“/”</li></ul> <div class="language- extra-class"><pre class="language-text"><code>if (-d $request_filename){
    rewrite ^/(.*)([^/])$ http://$host/$1$2/ permanent;
}
</code></pre></div><ul><li>禁止htaccess</li></ul> <div class="language- extra-class"><pre class="language-text"><code>location ~/\.ht {
    deny all;
}
</code></pre></div><ul><li>禁止多个目录</li></ul> <div class="language- extra-class"><pre class="language-text"><code>location ~ ^/(cron|templates)/ {
    deny all;
    break;
}
</code></pre></div><ul><li>禁止以/data开头的文件</li></ul> <div class="language- extra-class"><pre class="language-text"><code>可以禁止/data/下多级目录下.log.txt等请求;

location ~ ^/data {
    deny all;
}
</code></pre></div><ul><li>禁止单个目录</li></ul> <div class="language- extra-class"><pre class="language-text"><code>不能禁止.log.txt能请求

location /searchword/cron/ {
    deny all;
}
</code></pre></div><ul><li>禁止单个文件</li></ul> <div class="language- extra-class"><pre class="language-text"><code>location ~ /data/sql/data.sql {
    deny all;
}
</code></pre></div><ul><li>给favicon.ico和robots.txt设置过期时间;</li></ul> <div class="language- extra-class"><pre class="language-text"><code>location ~(favicon.ico) {
    log_not_found off;
    expires 99d;
    break;
}

location ~(robots.txt) {
    log_not_found off;
    expires 7d;
    break;
}

这里为favicon.ico为99 天,robots.txt为7天并不记录404错误日志
</code></pre></div><ul><li>设定某个文件的过期时间;这里为600秒，并不记录访问日志</li></ul> <div class="language- extra-class"><pre class="language-text"><code>location ^~ /html/scripts/loadhead_1.js {
    access_log off;
    root /opt/lampp/htdocs/web;
    expires 600;
    break;
}
</code></pre></div><ul><li>文件反盗链并设置过期时间</li></ul> <div class="language- extra-class"><pre class="language-text"><code>location ~* ^.+\.(jpg|jpeg|gif|png|swf|rar|zip|css|js)$ {
    valid_referers none blocked *.c1gstudio.com *.c1gstudio.net localhost 208.97.167.194;
    if ($invalid_referer) {
        rewrite ^/ http://leech.c1gstudio.com/leech.gif;
        return 412;
        break;
    }
    access_log off;
    root /opt/lampp/htdocs/web;
    expires 3d;
    break;
}

这里的return 412 为自定义的http状态码，默认为403，方便找出正确的盗链的请求
“rewrite ^/ http://leech.c1gstudio.com/leech.gif;”显示一张防盗链图片
“access_log off;”不记录访问日志，减轻压力
“expires 3d”所有文件3天的浏览器缓存

</code></pre></div><ul><li>只充许固定ip访问网站，并加上密码</li></ul> <div class="language- extra-class"><pre class="language-text"><code>root /opt/htdocs/www;
allow 208.97.167.194;
allow 222.33.1.2;
allow 231.152.49.4;
deny all;
auth_basic &quot;C1G_ADMIN&quot;;
auth_basic_user_file htpasswd;
</code></pre></div><ul><li>将多级目录下的文件转成一个文件，增强seo效果</li></ul> <div class="language- extra-class"><pre class="language-text"><code>/job-123-456-789.html 指向/job/123/456/789.html

rewrite ^/job-([0-9]+)-([0-9]+)-([0-9]+)\.html$ /job/$1/$2/jobshow_$3.html last;
</code></pre></div><ul><li>将根目录下某个文件夹指向2级目录</li></ul> <div class="language- extra-class"><pre class="language-text"><code>如/shanghaijob/ 指向 /area/shanghai/
如果你将last改成permanent，那么浏览器地址栏显是 /location/shanghai/

rewrite ^/([0-9a-z]+)job/(.*)$ /area/$1/$2 last;
</code></pre></div><ul><li>上面例子有个问题是访问/shanghai 时将不会匹配</li></ul> <div class="language- extra-class"><pre class="language-text"><code>rewrite ^/([0-9a-z]+)job$ /area/$1/ last;
rewrite ^/([0-9a-z]+)job/(.*)$ /area/$1/$2 last;
</code></pre></div><ul><li>这样/shanghai 也可以访问了，但页面中的相对链接无法使用，</li></ul> <div class="language- extra-class"><pre class="language-text"><code>如./list_1.html真实地址是/area /shanghia/list_1.html会变成/list_1.html,导至无法访问。
那我加上自动跳转也是不行咯
(-d $request_filename)它有个条件是必需为真实目录，而我的rewrite不是的，所以没有效果

if (-d $request_filename) {
    rewrite ^/(.*)([^/])$ http://$host/$1$2/ permanent;
}
</code></pre></div><ul><li>知道原因后就好办了，让我手动跳转吧</li></ul> <div class="language- extra-class"><pre class="language-text"><code>rewrite ^/([0-9a-z]+)job$ /$1job/ permanent;
rewrite ^/([0-9a-z]+)job/(.*)$ /area/$1/$2 last;
</code></pre></div><ul><li>文件和目录不存在的时候重定向：</li></ul> <div class="language- extra-class"><pre class="language-text"><code>if (!-e $request_filename) {
    proxy_pass http://127.0.0.1;
}
</code></pre></div><ul><li>域名跳转</li></ul> <div class="language- extra-class"><pre class="language-text"><code>server {
    listen 80;
    server_name jump.c1gstudio.com;
    index index.html index.htm index.php;
    root /opt/lampp/htdocs/www;
    rewrite ^/ http://www.c1gstudio.com/;
    access_log off;
}
</code></pre></div><ul><li>多域名转向</li></ul> <div class="language- extra-class"><pre class="language-text"><code>server_name www.c1gstudio.com www.c1gstudio.net;
index index.html index.htm index.php;
root /opt/lampp/htdocs;
if ($host ~ &quot;c1gstudio\.net&quot;) {
    rewrite ^(.*) http://www.c1gstudio.com$1 permanent;
}
</code></pre></div><ul><li>三级域名跳转</li></ul> <div class="language- extra-class"><pre class="language-text"><code>if ($http_host ~* &quot;^(.*)\.i\.c1gstudio\.com$&quot;) {
    rewrite ^(.*) http://top.yingjiesheng.com$1;
    break;
}
</code></pre></div><ul><li>域名镜向</li></ul> <div class="language- extra-class"><pre class="language-text"><code>server {
    listen 80;
    server_name mirror.c1gstudio.com;
    index index.html index.htm index.php;
    root /opt/lampp/htdocs/www;
    rewrite ^/(.*) http://www.c1gstudio.com/$1 last;
    access_log off;
}
</code></pre></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/20/2018, 5:13:23 PM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.9c3b2f40.js" defer></script><script src="/assets/js/35.c94db349.js" defer></script>
  </body>
</html>
