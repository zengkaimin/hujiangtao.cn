(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{90:function(t,n,a){"use strict";a.r(n);var e=a(0),s=Object(e.a)({},function(){var t=this,n=t.$createElement,a=t._self._c||n;return a("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),a("p"),t._m(2),a("p"),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),a("p",[t._v("但是使用Nginx一般的反向代理配置是完不成这个功能的。")]),t._v(" "),t._m(5),t._v(" "),t._m(6),t._v(" "),t._m(7),a("p",[t._v("但是以上配置是不成功的，主要原因在与Nginx默认的http协议为http 1.0，其中http 1.0与1.1最大的区别在于1.0 是不支持keep-alive的，但是supervisor的输出日志是需要keep-alive，所以需要启用http 1.1，同时要支持keep-alive。")]),t._v(" "),t._m(8),t._v(" "),t._m(9),t._m(10),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"http://www.cnblogs.com/liaojiafa/p/6130390.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Nginx系列5之让Nginx支持HTTP1.1"),a("OutboundLink")],1)])]),t._v(" "),t._m(11),a("ul",[a("li",[a("a",{attrs:{href:"https://blog.csdn.net/gxl0805/article/details/24263443",target:"_blank",rel:"noopener noreferrer"}},[t._v("nginx配置http为1.0到1.1，主要是为了长连接有效 - CSDN"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive",target:"_blank",rel:"noopener noreferrer"}},[t._v("ngx_http_upstream_module.html#keepalive - Nginx"),a("OutboundLink")],1)])])])},[function(){var t=this.$createElement,n=this._self._c||t;return n("h1",{attrs:{id:"nginx反向代理supervisor日志"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx反向代理supervisor日志","aria-hidden":"true"}},[this._v("#")]),this._v(" Nginx反向代理supervisor日志")])},function(){var t=this.$createElement,n=this._self._c||t;return n("h2",{attrs:{id:"目录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目录","aria-hidden":"true"}},[this._v("#")]),this._v(" 目录")])},function(){var t=this.$createElement,n=this._self._c||t;return n("div",{staticClass:"table-of-contents"},[n("ul",[n("li",[n("a",{attrs:{href:"#目录"}},[this._v("目录")])]),n("li",[n("a",{attrs:{href:"#简介"}},[this._v("简介")])]),n("li",[n("a",{attrs:{href:"#分析"}},[this._v("分析")])]),n("li",[n("a",{attrs:{href:"#reference"}},[this._v("Reference")])])])])},function(){var t=this.$createElement,n=this._self._c||t;return n("h2",{attrs:{id:"简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#简介","aria-hidden":"true"}},[this._v("#")]),this._v(" 简介")])},function(){var t=this.$createElement,n=this._self._c||t;return n("blockquote",[n("p",[this._v("Supervisor输出的日志在web端可通过ip:9001查看，但是有时候又不想把supervisor的服务暴露出去，这个时候就需要Nginx走反向代理，只把supervisor的输出日志暴露外部查看")])])},function(){var t=this.$createElement,n=this._self._c||t;return n("h2",{attrs:{id:"分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#分析","aria-hidden":"true"}},[this._v("#")]),this._v(" 分析")])},function(){var t=this.$createElement,n=this._self._c||t;return n("ul",[n("li",[this._v("一般配置如下：")])])},function(){var t=this,n=t.$createElement,a=t._self._c||n;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 一般的反向代理配置无外乎如下两种，一种比较简单，一种使用较为普遍")]),t._v("\nserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    listen       8001"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    server_name  localhost 192.168.2.60"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    error_page   500 502 503 504  /50x.html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    location "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" /50x.html "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        root   html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# proxy pass web & cms")]),t._v("\n    location /web "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#deny all;")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# http://127.0.0.1:9001/logtail/local-web")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#rewrite ^ http://127.0.0.1:9001/logtail/local-web;")]),t._v("\n        proxy_pass   http://127.0.0.1:9001/logtail/local-web"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_redirect     off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_set_header   Host             "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_set_header   X-Real-IP        "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_set_header   X-Forwarded-For  "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$proxy_add_x_forwarded_for")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    location /cms "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        proxy_pass http://127.0.0.1:9001/logtail/local-cms"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# deny access to all others")]),t._v("\n    location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        deny  all"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,n=this._self._c||t;return n("ul",[n("li",[this._v("修改后的配置如下：")])])},function(){var t=this,n=t.$createElement,a=t._self._c||n;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    listen       8001"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    server_name  localhost 192.168.2.60"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    error_page   500 502 503 504  /50x.html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    location "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" /50x.html "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        root   html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# proxy pass web & cms")]),t._v("\n    location /web "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#deny all;")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# http://127.0.0.1:9001/logtail/local-web")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#rewrite ^ http://127.0.0.1:9001/logtail/local-web;")]),t._v("\n        proxy_pass   http://127.0.0.1:9001/logtail/local-web"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# http 1.0不支持keep-alive, 1.1支持")]),t._v("\n        proxy_http_version 1.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_redirect     off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_set_header   Host             "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_set_header   X-Real-IP        "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_set_header   X-Forwarded-For  "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$proxy_add_x_forwarded_for")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 保持keep-alive")]),t._v("\n        proxy_set_header   Connection       "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    location /cms "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        proxy_pass http://127.0.0.1:9001/logtail/local-cms"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_http_version  1.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        proxy_set_header   Connection    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# deny access to all others")]),t._v("\n    location / "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        deny  all"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,n=this._self._c||t;return n("h2",{attrs:{id:"reference"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#reference","aria-hidden":"true"}},[this._v("#")]),this._v(" Reference")])},function(){var t=this.$createElement,n=this._self._c||t;return n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[this._v("Nginx系列5之让Nginx支持HTTP1.1\n\nnginx在反向代理HTTP协议的时候，默认使用的是HTTP1.0去向后端服务器获取响应的内容后在返回给客户端。\nHTTP1.0和HTTP1.1的一个不同之处就是，HTTP1.0不支持HTTP keep-alive。nginx在后端服务器请求时使用了HTTP1.0同时使用HTTP Header的Connection：Close通知后端服务器主动关闭连接。这样会导致任何一个客户端的请求都在后端服务器上产生了一个TIME-WAIT状态的连接。所以我们需要在Nginx上启用HTTP1.1的向后端发送请求，同时支持Keep-alive。\n配置HTTP1.1\nhttp{\n''' 省去其他的配置\n    upstream www{\n        keepalive 50; # 必须配置，建议50-100之间\n        '''\n    }\n    server {\n    '''省去其他的配置\n        location / {\n        proxy_http_version 1.1; # 后端配置支持HTTP1.1，必须配\n        proxy_set_header Connection \"\";   # 后端配置支持HTTP1.1 ,必须配置。\n        }\n    '''\n\n    }\n'''\n}\n我们增加三个参数keepalive 50，proxy_http_version 1.1 , proxy_set_header Connection 来配置。\n")])])])}],!1,null,null,null);n.default=s.exports}}]);